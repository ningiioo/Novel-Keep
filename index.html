<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°èªªé–±è®€å™¨</title>
  <style>
    body { font-family: sans-serif; background: #f8f8f8; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
    h1 { text-align: center; }
    form { margin-bottom: 32px; }
    label { display: block; margin-top: 16px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; border: 1px solid #ccc; }
    button { margin-top: 16px; padding: 10px 24px; border: none; background: #4f8cff; color: #fff; border-radius: 4px; cursor: pointer; }
    .novel-list { margin-top: 32px; }
    .novel-item { background: #f0f4ff; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .novel-title { font-size: 1.2em; font-weight: bold; }
    .novel-meta { color: #666; font-size: 0.95em; margin-bottom: 8px; }
    .novel-content { white-space: pre-wrap; }
    .bottom-nav {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      padding: 0;
      z-index: 10;
    }
    .bottom-nav button {
      flex: 1;
      padding: 16px 0;
      border: none;
      background: none;
      font-size: 1.1em;
      color: #4f8cff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .bottom-nav button.active {
      background: #e6f0ff;
      font-weight: bold;
    }
    .page { min-height: 400px; }
    @media (max-width: 700px) {
      .container { padding-bottom: 80px; }
    }
    body[data-theme="dark"] {
      background: #181c1f;
      color: #e0e0e0;
    }
    body[data-theme="dark"] .container {
      background: #23272b;
      box-shadow: 0 2px 8px #0008;
    }
    body[data-theme="dark"] .novel-item {
      background: #222c3a;
    }
    body[data-theme="dark"] .bottom-nav {
      background: #23272b;
      border-top: 1px solid #333;
    }
    body[data-theme="dark"] .bottom-nav button {
      color: #90c4ff;
    }
    body[data-theme="dark"] .bottom-nav button.active {
      background: #1a2330;
    }
    .novel-content {
      font-size: var(--novel-font-size, 18px);
      line-height: var(--novel-line-height, 1.6);
    }
    #page-reader-novel {
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #readerTools {
      box-shadow: 0 -2px 12px #0002;
    }
    #readerTools.hide {
      transform: translateY(100%);
    }
    .lib-mode-btn.active {
      background: #e6f0ff;
      color: #4f8cff;
      font-weight: bold;
    }
    .novel-actions {
      display: inline-flex;
      gap: 8px;
      margin-left: 8px;
      vertical-align: middle;
    }
    .novel-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1em;
      color: #888;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .novel-action-btn:hover {
      background: #e6f0ff;
      color: #4f8cff;
    }
    .tag-list {
      display: inline-flex;
      gap: 8px;
      margin-left: 8px;
      vertical-align: middle;
    }
    .tag-badge {
      display: inline-block;
      padding: 2px 18px;
      border-radius: 20px;
      font-size: 1em;
      border: 2px solid #7fd0e8;
      color: #21809b;
      background: #eaf6fd;
      font-weight: 500;
      letter-spacing: 1px;
    }
    .tag-badge.urgent {
      border-color: #ffe08a;
      color: #b48a00;
      background: #fff8e1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="page-reader" class="page">
      <h1>å°èªªé–±è®€å™¨</h1>
      <form id="novelForm">
        <label for="name">å°èªªåç¨±</label>
        <input type="text" id="name" required>
        <label for="author">ä½œè€…</label>
        <input type="text" id="author" required>
        <label for="category">åˆ†é¡</label>
        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
          <select id="category" required style="flex:1"></select>
          <button type="button" id="editCategoryBtn" style="padding:4px 10px;">ç®¡ç†åˆ†é¡</button>
        </div>
        <label for="url">ç¶²å€</label>
        <input type="url" id="url" placeholder="https://...">
        <label for="desc">ç°¡ä»‹</label>
        <textarea id="desc" rows="2" placeholder="ç°¡çŸ­ä»‹ç´¹"></textarea>
        <label for="date">æ—¥æœŸ</label>
        <input type="date" id="date">
        <label for="tags">æ¨™ç±¤ï¼ˆå¯ç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
        <input type="text" id="tags" placeholder="å¦‚ï¼šå¥‡å¹»,å†’éšª,ç¶“å…¸">
        <div id="allTagsList" style="margin:8px 0 16px 0;display:flex;flex-wrap:wrap;gap:8px;"></div>
        <label for="content">å…§æ–‡</label>
        <textarea id="content" rows="6" required></textarea>
        <button type="submit">æ–°å¢å°èªª</button>
      </form>
    </div>
    <div id="page-library" class="page" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <h2 style="margin:0;">æ›¸åº«</h2>
        <div style="display:flex;gap:8px;">
          <button type="button" id="libByCategoryBtn" class="lib-mode-btn active">ä¾åˆ†é¡</button>
          <button type="button" id="libAllBtn" class="lib-mode-btn">å…¨éƒ¨</button>
        </div>
      </div>
      <div id="libCategoryView">
        <div class="novel-list" id="categoryListView"></div>
      </div>
      <div id="libAllView" style="display:none;">
        <div class="novel-list" id="allListView"></div>
      </div>
      <div id="libNovelsByCatView" style="display:none;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <button type="button" id="backToCategoryBtn">â† è¿”å›åˆ†é¡</button>
          <h3 id="catTitle" style="flex:1;margin:0;"></h3>
          <button type="button" id="toggleEditModeBtn" style="padding:4px 12px;">ç·¨è¼¯</button>
        </div>
        <div class="novel-list" id="novelsByCatList"></div>
      </div>
    </div>
    <div id="page-reader-novel" class="page" style="display:none;position:fixed;z-index:100;left:0;top:0;width:100vw;height:100vh;background:var(--reader-bg,#fff);color:var(--reader-color,#222);overflow:auto;">
      <div id="readerContent" style="max-width:700px;margin:0 auto;padding:32px 16px 80px 16px;"></div>
      <div id="readerTools" style="position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,0.98);border-top:1px solid #ddd;padding:12px 0;display:flex;gap:16px;justify-content:center;align-items:center;transition:transform 0.3s;z-index:101;">
        <label>å­—é«”
          <select id="readerFontSize">
            <option value="16">æ¥µå°</option>
            <option value="18">å°</option>
            <option value="20">ä¸­</option>
            <option value="22">å¤§</option>
            <option value="24">ç‰¹å¤§</option>
            <option value="28">è¶…å¤§</option>
          </select>
        </label>
        <label>è¡Œè·
          <select id="readerLineHeight">
            <option value="1.2">æ¥µç·Š</option>
            <option value="1.4">ç·Š</option>
            <option value="1.6">ä¸€èˆ¬</option>
            <option value="1.8">å¯¬</option>
            <option value="2.0">ç‰¹å¯¬</option>
            <option value="2.4">è¶…å¯¬</option>
          </select>
        </label>
        <label>èƒŒæ™¯
          <select id="readerBgColor">
            <option value="#fff">ç™½</option>
            <option value="#f5f5dc">ç±³</option>
            <option value="#222">é»‘</option>
            <option value="#e3f2fd">è—</option>
          </select>
        </label>
        <button id="closeReaderBtn" style="margin-left:16px;">é—œé–‰</button>
      </div>
    </div>
    <div id="page-settings" class="page" style="display:none">
      <h2>è¨­å®š</h2>
      <div style="margin-bottom: 24px;">
        <label>ä¸»é¡Œï¼š
          <select id="themeSelect">
            <option value="light">äº®è‰²</option>
            <option value="dark">æš—è‰²</option>
          </select>
        </label>
      </div>
      <div style="margin-bottom: 24px;">
        <label>å­—é«”å¤§å°ï¼š
          <input type="range" id="fontSizeRange" min="14" max="28" value="18">
          <span id="fontSizeValue">18</span> px
        </label>
      </div>
      <div style="margin-bottom: 24px;">
        <label>è¡Œè·ï¼š
          <input type="range" id="lineHeightRange" min="1.2" max="2.2" step="0.1" value="1.6">
          <span id="lineHeightValue">1.6</span>
        </label>
      </div>
    </div>
    <nav class="bottom-nav">
      <button type="button" data-page="reader">é–±è®€å™¨</button>
      <button type="button" data-page="library">æ›¸åº«</button>
      <button type="button" data-page="settings">è¨­å®š</button>
    </nav>
    <!-- åˆ†é¡ç®¡ç†å°è©±æ¡† -->
    <dialog id="categoryDialog">
      <form method="dialog" id="categoryForm" style="min-width:260px;">
        <h3>ç®¡ç†åˆ†é¡</h3>
        <ul id="categoryList" style="list-style:none;padding:0;margin-bottom:12px;"></ul>
        <div style="display:flex;gap:8px;">
          <input type="text" id="newCategoryInput" placeholder="æ–°å¢åˆ†é¡" style="flex:1;">
          <button type="button" id="addCategoryBtn">æ–°å¢</button>
        </div>
        <div style="text-align:right;margin-top:12px;">
          <button type="submit">å®Œæˆ</button>
        </div>
      </form>
    </dialog>
  </div>
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAX0SfHvlelWWdg7Q-8WHzmWNdKE2vtI3w",
      authDomain: "to-buy-list-2323b.firebaseapp.com",
      projectId: "to-buy-list-2323b",
      storageBucket: "to-buy-list-2323b.firebasestorage.app",
      messagingSenderId: "363437967200",
      appId: "1:363437967200:web:798c997017e75d2a278005"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const novelsCol = collection(db, "novels");

    // æ–°å¢å°èªª
    document.getElementById('novelForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const author = document.getElementById('author').value.trim();
      const category = document.getElementById('category').value;
      const url = document.getElementById('url').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const date = document.getElementById('date').value;
      const tags = document.getElementById('tags').value.split(',').map(t=>t.trim()).filter(Boolean);
      const content = document.getElementById('content').value.trim();
      if (!name || !author || !category || !content) return;
      await addDoc(novelsCol, { name, author, category, url, desc, date, tags, content, createdAt: Date.now() });
      document.getElementById('novelForm').reset();
    });

    // åªç”¨æ–¼æ›¸åº«é¡¯ç¤º
    const q = query(novelsCol, orderBy('createdAt', 'desc'));
    let novelsCache = [];
    onSnapshot(q, (snapshot) => {
      novelsCache = [];
      snapshot.forEach(doc => {
        const { name, author, category, url, desc, date, tags, content } = doc.data();
        novelsCache.push({ id: doc.id, name, author, category, url, desc, date, tags, content });
      });
      renderLibrary(novelsCache);
      renderAllTagsList();
    });

    // åˆ†é åˆ‡æ›
    const pages = ['reader', 'library', 'settings'];
    const navBtns = document.querySelectorAll('.bottom-nav button');
    function showPage(page) {
      pages.forEach(p => {
        document.getElementById('page-' + p).style.display = (p === page) ? '' : 'none';
      });
      navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.page === page));
    }
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => showPage(btn.dataset.page));
    });
    // é è¨­é¡¯ç¤ºé–±è®€å™¨
    showPage('reader');

    // ====== è¨­å®šåŠŸèƒ½ ======
    // ä¸»é¡Œåˆ‡æ›
    const themeSelect = document.getElementById('themeSelect');
    themeSelect.addEventListener('change', e => {
      document.body.setAttribute('data-theme', e.target.value);
      localStorage.setItem('novel-theme', e.target.value);
    });
    // å­—é«”å¤§å°
    const fontSizeRange = document.getElementById('fontSizeRange');
    const fontSizeValue = document.getElementById('fontSizeValue');
    fontSizeRange.addEventListener('input', e => {
      document.documentElement.style.setProperty('--novel-font-size', e.target.value + 'px');
      fontSizeValue.textContent = e.target.value;
      localStorage.setItem('novel-font-size', e.target.value);
    });
    // è¡Œè·
    const lineHeightRange = document.getElementById('lineHeightRange');
    const lineHeightValue = document.getElementById('lineHeightValue');
    lineHeightRange.addEventListener('input', e => {
      document.documentElement.style.setProperty('--novel-line-height', e.target.value);
      lineHeightValue.textContent = e.target.value;
      localStorage.setItem('novel-line-height', e.target.value);
    });
    // è¼‰å…¥æœ¬åœ°è¨­å®š
    window.addEventListener('DOMContentLoaded', () => {
      const theme = localStorage.getItem('novel-theme') || 'light';
      document.body.setAttribute('data-theme', theme);
      themeSelect.value = theme;
      const fontSize = localStorage.getItem('novel-font-size') || '18';
      document.documentElement.style.setProperty('--novel-font-size', fontSize + 'px');
      fontSizeRange.value = fontSize;
      fontSizeValue.textContent = fontSize;
      const lineHeight = localStorage.getItem('novel-line-height') || '1.6';
      document.documentElement.style.setProperty('--novel-line-height', lineHeight);
      lineHeightRange.value = lineHeight;
      lineHeightValue.textContent = lineHeight;
    });

    // ====== åˆ†é¡ç®¡ç† ======
    const defaultCategories = ["å¥‡å¹»", "æ„›æƒ…", "ç§‘å¹»", "æ¨ç†", "æ­·å²", "å…¶ä»–"];
    function getCategories() {
      return JSON.parse(localStorage.getItem('novel-categories') || 'null') || defaultCategories;
    }
    function setCategories(cats) {
      localStorage.setItem('novel-categories', JSON.stringify(cats));
    }
    function renderCategoryOptions() {
      const cats = getCategories();
      categorySelect.innerHTML = '';
      cats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }
    // åˆå§‹åŒ–åˆ†é¡ä¸‹æ‹‰
    const categorySelect = document.getElementById('category');
    renderCategoryOptions();

    // åˆ†é¡ç®¡ç†å°è©±æ¡†
    const categoryDialog = document.getElementById('categoryDialog');
    const categoryList = document.getElementById('categoryList');
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    document.getElementById('editCategoryBtn').onclick = () => {
      renderCategoryList();
      categoryDialog.showModal();
    };
    function renderCategoryList() {
      const cats = getCategories();
      categoryList.innerHTML = '';
      cats.forEach((cat, idx) => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '6px';
        li.innerHTML = `
          <input type="text" value="${cat}" data-idx="${idx}" style="flex:1;">
          <button type="button" data-idx="${idx}" class="delCatBtn">åˆªé™¤</button>
        `;
        categoryList.appendChild(li);
      });
    }
    // æ–°å¢åˆ†é¡
    addCategoryBtn.onclick = () => {
      const val = newCategoryInput.value.trim();
      if (!val) return;
      let cats = getCategories();
      if (!cats.includes(val)) {
        cats.push(val);
        setCategories(cats);
        renderCategoryList();
        renderCategoryOptions();
        newCategoryInput.value = '';
      }
    };
    // åˆªé™¤åˆ†é¡
    categoryList.addEventListener('click', e => {
      if (e.target.classList.contains('delCatBtn')) {
        const idx = +e.target.dataset.idx;
        let cats = getCategories();
        cats.splice(idx, 1);
        setCategories(cats);
        renderCategoryList();
        renderCategoryOptions();
      }
    });
    // ä¿®æ”¹åˆ†é¡
    categoryList.addEventListener('input', e => {
      if (e.target.tagName === 'INPUT') {
        const idx = +e.target.dataset.idx;
        let cats = getCategories();
        cats[idx] = e.target.value;
        setCategories(cats);
        renderCategoryOptions();
      }
    });
    // å®Œæˆé—œé–‰
    document.getElementById('categoryForm').onsubmit = e => {
      e.preventDefault();
      categoryDialog.close();
    };
    // è‹¥ localStorage æ²’æœ‰åˆ†é¡ï¼Œåˆå§‹åŒ–ä¸€æ¬¡
    if (!localStorage.getItem('novel-categories')) {
      setCategories(defaultCategories);
    }

    // ====== é–±è®€é åŠŸèƒ½ ======
    const pageReaderNovel = document.getElementById('page-reader-novel');
    const readerContent = document.getElementById('readerContent');
    const readerTools = document.getElementById('readerTools');
    const readerFontSize = document.getElementById('readerFontSize');
    const readerLineHeight = document.getElementById('readerLineHeight');
    const readerBgColor = document.getElementById('readerBgColor');
    const closeReaderBtn = document.getElementById('closeReaderBtn');
    let readerColorMap = { '#fff': '#222', '#f5f5dc': '#222', '#222': '#eee', '#e3f2fd': '#222' };
    // é»æ“Šå°èªªé€²å…¥é–±è®€é 
    function showReaderPage(novel) {
      readerContent.innerHTML = `
        <div style="font-size:1.3em;font-weight:bold;margin-bottom:8px;">${novel.name}${renderTagBadges(novel.tags)}</div>
        <div style="color:#888;font-size:0.95em;margin-bottom:8px;">ä½œè€…ï¼š${novel.author}ã€€åˆ†é¡ï¼š${novel.category}</div>
        <div style="color:#888;font-size:0.95em;margin-bottom:8px;">${novel.date ? 'æ—¥æœŸï¼š'+novel.date+'ã€€' : ''}</div>
        <div style="color:#888;font-size:0.95em;margin-bottom:8px;">${novel.url ? `<a href="${novel.url}" target="_blank">é€£çµ</a>` : ''}</div>
        <div style="color:#888;font-size:0.95em;margin-bottom:16px;">${novel.desc || ''}</div>
        <div class="novel-content" id="readerNovelContent">${novel.content}</div>
      `;
      // å¥—ç”¨é è¨­
      readerFontSize.value = localStorage.getItem('reader-font-size') || 18;
      readerLineHeight.value = localStorage.getItem('reader-line-height') || 1.6;
      readerBgColor.value = localStorage.getItem('reader-bg') || '#fff';
      applyReaderStyle();
      pageReaderNovel.style.display = '';
      document.body.style.overflow = 'hidden';
      readerTools.classList.remove('hide');
    }
    function applyReaderStyle() {
      const fs = readerFontSize.value;
      const lh = readerLineHeight.value;
      const bg = readerBgColor.value;
      // åªèª¿æ•´å…§æ–‡
      const contentEl = document.getElementById('readerNovelContent');
      if (contentEl) {
        contentEl.style.fontSize = fs + 'px';
        contentEl.style.lineHeight = lh;
      }
      pageReaderNovel.style.setProperty('--reader-bg', bg);
      pageReaderNovel.style.setProperty('--reader-color', readerColorMap[bg] || '#222');
      localStorage.setItem('reader-font-size', fs);
      localStorage.setItem('reader-line-height', lh);
      localStorage.setItem('reader-bg', bg);
    }
    readerFontSize.addEventListener('change', applyReaderStyle);
    readerLineHeight.addEventListener('change', applyReaderStyle);
    readerBgColor.addEventListener('change', applyReaderStyle);
    // é—œé–‰é–±è®€é 
    closeReaderBtn.onclick = () => {
      pageReaderNovel.style.display = 'none';
      document.body.style.overflow = '';
    };
    // é»æ“Šè¢å¹•éš±è—/é¡¯ç¤ºå·¥å…·åˆ—
    let lastTap = 0;
    pageReaderNovel.addEventListener('click', e => {
      // é¿å…é»æ“Šå·¥å…·åˆ—æœ¬èº«
      if (e.target.closest('#readerTools')) return;
      if (readerTools.classList.contains('hide')) {
        readerTools.classList.remove('hide');
      } else {
        readerTools.classList.add('hide');
      }
    });
    // é€²å…¥é–±è®€é æ™‚è‡ªå‹•é¡¯ç¤ºå·¥å…·åˆ—
    // ... existing code ...

    // ====== æ›¸åº«é¡¯ç¤ºæ¨¡å¼ ======
    const libByCategoryBtn = document.getElementById('libByCategoryBtn');
    const libAllBtn = document.getElementById('libAllBtn');
    const libCategoryView = document.getElementById('libCategoryView');
    const libAllView = document.getElementById('libAllView');
    const libNovelsByCatView = document.getElementById('libNovelsByCatView');
    const categoryListView = document.getElementById('categoryListView');
    const allListView = document.getElementById('allListView');
    const novelsByCatList = document.getElementById('novelsByCatList');
    const catTitle = document.getElementById('catTitle');
    const backToCategoryBtn = document.getElementById('backToCategoryBtn');
    const toggleEditModeBtn = document.getElementById('toggleEditModeBtn');
    let currentLibMode = 'category';
    let editMode = false;
    function switchLibMode(mode) {
      currentLibMode = mode;
      libByCategoryBtn.classList.toggle('active', mode==='category');
      libAllBtn.classList.toggle('active', mode==='all');
      libCategoryView.style.display = mode==='category' ? '' : 'none';
      libAllView.style.display = mode==='all' ? '' : 'none';
      libNovelsByCatView.style.display = 'none';
    }
    libByCategoryBtn.onclick = () => switchLibMode('category');
    libAllBtn.onclick = () => switchLibMode('all');
    backToCategoryBtn.onclick = () => {
      libNovelsByCatView.style.display = 'none';
      libCategoryView.style.display = '';
    };
    // æ›¸åº«è³‡æ–™æ¸²æŸ“
    function renderTagBadges(tags) {
      if (!tags || !tags.length) return '';
      return `<span class="tag-list">` + tags.map(tag => {
        const urgent = tag === 'æ€¥' || tag.toLowerCase() === 'urgent';
        return `<span class="tag-badge${urgent ? ' urgent' : ''}">${tag}</span>`;
      }).join('') + `</span>`;
    }
    function renderLibrary(novels) {
      // ä¾åˆ†é¡
      const cats = getCategories();
      categoryListView.innerHTML = '';
      cats.forEach(cat => {
        const count = novels.filter(n=>n.category===cat).length;
        categoryListView.innerHTML += `<div class="novel-item cat-item" data-cat="${cat}" style="cursor:pointer;">
          <div class="novel-title">${cat}</div>
          <div class="novel-meta">${count} æœ¬å°èªª</div>
        </div>`;
      });
      // å…¨éƒ¨
      const sorted = [...novels].sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
      allListView.innerHTML = '';
      sorted.forEach(novel => {
        allListView.innerHTML += `
          <div class="novel-item" data-id="${novel.id}" style="cursor:pointer;">
            <div class="novel-title">${novel.name}${renderTagBadges(novel.tags)}</div>
            <div class="novel-meta">ä½œè€…ï¼š${novel.author}ã€€åˆ†é¡ï¼š${novel.category}</div>
            <div class="novel-meta">${novel.date ? 'æ—¥æœŸï¼š'+novel.date+'ã€€' : ''}</div>
            <div class="novel-meta">${novel.url ? `<a href="${novel.url}" target="_blank">é€£çµ</a>` : ''}</div>
            <div class="novel-meta">${novel.desc || ''}</div>
            <div class="novel-content" style="max-height:4.5em;overflow:hidden;">${novel.content}</div>
          </div>
        `;
      });
    }
    // é»åˆ†é¡é¡¯ç¤ºè©²åˆ†é¡å°èªª
    categoryListView.addEventListener('click', e => {
      let item = e.target.closest('.cat-item');
      if (!item) return;
      let cat = item.dataset.cat;
      showNovelsByCategory(cat);
    });
    function showNovelsByCategory(cat) {
      catTitle.textContent = cat;
      libCategoryView.style.display = 'none';
      libNovelsByCatView.style.display = '';
      editMode = false;
      toggleEditModeBtn.textContent = 'ç·¨è¼¯';
      renderNovelsByCatList(cat);
    }
    function renderNovelsByCatList(cat) {
      const novels = novelsCache.filter(n=>n.category===cat);
      novelsByCatList.innerHTML = '';
      novels.forEach(novel => {
        novelsByCatList.innerHTML += `
          <div class="novel-item" data-id="${novel.id}" style="cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div class="novel-title">${novel.name}${renderTagBadges(novel.tags)}</div>
              <div class="novel-meta">ä½œè€…ï¼š${novel.author}ã€€åˆ†é¡ï¼š${novel.category}</div>
              <div class="novel-meta">${novel.date ? 'æ—¥æœŸï¼š'+novel.date+'ã€€' : ''}</div>
              <div class="novel-meta">${novel.url ? `<a href="${novel.url}" target="_blank">é€£çµ</a>` : ''}</div>
              <div class="novel-meta">${novel.desc || ''}</div>
              <div class="novel-content" style="max-height:4.5em;overflow:hidden;">${novel.content}</div>
            </div>
            <span class="novel-actions" style="${editMode ? '' : 'display:none;'}">
              <button class="novel-action-btn edit-btn" title="ç·¨è¼¯" data-id="${novel.id}">âœï¸</button>
              <button class="novel-action-btn delete-btn" title="åˆªé™¤" data-id="${novel.id}">ğŸ—‘ï¸</button>
            </span>
          </div>
        `;
      });
    }
    toggleEditModeBtn.onclick = () => {
      editMode = !editMode;
      toggleEditModeBtn.textContent = editMode ? 'å®Œæˆ' : 'ç·¨è¼¯';
      renderNovelsByCatList(catTitle.textContent);
    };
    // é»å°èªªé€²å…¥é–±è®€é ï¼ˆåˆ†é¡/å…¨éƒ¨/åˆ†é¡å…§ï¼‰
    [allListView, novelsByCatList].forEach(listView => {
      listView.addEventListener('click', e => {
        if (!e.target.classList.contains('novel-title')) return;
        let item = e.target.closest('.novel-item');
        if (!item) return;
        let id = item.dataset.id;
        let novel = novelsCache.find(n => n.id === id);
        if (!novel) return;
        showReaderPage(novel);
      });
    });

    // ====== æ¨™ç±¤è¨˜æ†¶èˆ‡é¸æ“‡ ======
    function getAllTagsFromNovels() {
      const tagsSet = new Set();
      novelsCache.forEach(novel => {
        if (Array.isArray(novel.tags)) {
          novel.tags.forEach(tag => tagsSet.add(tag));
        }
      });
      return Array.from(tagsSet).filter(Boolean);
    }
    function renderAllTagsList() {
      const allTags = getAllTagsFromNovels();
      const allTagsList = document.getElementById('allTagsList');
      if (!allTagsList) return;
      allTagsList.innerHTML = '';
      allTags.forEach(tag => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = tag;
        btn.className = 'tag-badge';
        btn.style.cursor = 'pointer';
        btn.onclick = () => {
          const tagsInput = document.getElementById('tags');
          let tagsArr = tagsInput.value.split(',').map(t=>t.trim()).filter(Boolean);
          if (!tagsArr.includes(tag)) {
            tagsArr.push(tag);
            tagsInput.value = tagsArr.join(', ');
          }
        };
        allTagsList.appendChild(btn);
      });
    }
  </script>
</body>
</html> 