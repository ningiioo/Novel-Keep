<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°èªªé–±è®€å™¨</title>
  <style>
    body { font-family: sans-serif; background: #f8f8f8; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
    h2 { text-align: center; }
    form { margin-bottom: 32px; }
    label { display: block; margin-top: 16px; }
    input, select, textarea { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    button { padding: 10px 24px; border: none; background: #4f8cff; color: #fff; border-radius: 4px; cursor: pointer; }
    .novel-list { margin-top: 32px; }
    .novel-item {
      background: none;
      border-radius: 0;
      box-shadow: none;
      padding: 0 0 25px 0;
      border: none;
      border-bottom: 1px solid #d0d3d7;
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-bottom: 16px;
    }
    .novel-item:last-child {
      border-bottom: none;
    }
    .novel-row {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      margin-top: 0;
      margin-bottom: 0;
      padding: 0 24px;
    }
    .novel-title {
      font-size: 1em;
      font-weight: bold;
      color: #111;
      margin: 0;
      padding: 0;
      line-height: 1.2;
      cursor: pointer;
      letter-spacing: 0.5px;
    }
    /* Date */
    .novel-meta-row {
      display: flex;
      align-items: center;
      gap: 48px;
      color: #888;
      font-size: 0.9em;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .tag-list {
      display: flex;
      gap: 5px;
      margin: 0 0 0 0;
      padding: 0;
    }
    .tag-badge {
      border-radius: 999px;
      padding: 8px 32px;
      font-size: 0.9em;
      border: none;
      background: #f2f8fc;
      color: #4a6a7c;
      font-weight: 500;
      letter-spacing: 1px;
    }
    .tag-badge.urgent {
      background: #fff8e1;
      color: #b48a00;
    }
    .novel-desc {
      color: #888;
      font-size: 0.9em;
      margin: 16px 24px 0 24px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      line-height: 1.2;
    }
    .bottom-nav {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      padding: 0;
      z-index: 10;
    }
    .bottom-nav button {
      flex: 1;
      padding: 16px 0;
      border: none;
      background: none;
      font-size: 1.1em;
      color: #4f8cff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .bottom-nav button.active {
      background: #e6f0ff;
      font-weight: bold;
    }
    .page { min-height: 400px; }
    @media (max-width: 700px) {
      .container { padding-bottom: 80px; }
    }
    body[data-theme="dark"] {
      background: #181c1f;
      color: #e0e0e0;
    }
    body[data-theme="dark"] .container {
      background: #23272b;
      box-shadow: 0 2px 8px #0008;
    }
    body[data-theme="dark"] .novel-item {
      background: #222c3a;
    }
    body[data-theme="dark"] .bottom-nav {
      background: #23272b;
      border-top: 1px solid #333;
    }
    body[data-theme="dark"] .bottom-nav button {
      color: #90c4ff;
    }
    body[data-theme="dark"] .bottom-nav button.active {
      background: #1a2330;
    }
    .novel-content {
      font-size: var(--novel-font-size, 18px);
      line-height: var(--novel-line-height, 1.6);
    }
    #page-reader-novel {
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #readerTools {
      box-shadow: 0 -2px 12px #0002;
    }
    #readerTools.hide {
      transform: translateY(100%);
    }
    .lib-mode-btn.active {
      background: #e6f0ff;
      color: #4f8cff;
      font-weight: bold;
    }
    .novel-actions {
      display: inline-flex;
      gap: 8px;
      margin-left: 8px;
      vertical-align: middle;
    }
    .novel-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1em;
      color: #888;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .novel-action-btn:hover {
      background: #e6f0ff;
      color: #4f8cff;
    }
    /* æ›¸åº«å°èªªåˆ—è¡¨å­—é«”ç¸®å° */
    .novel-list .novel-item {
      font-size: 0.97em;
    }
    .novel-list .novel-title {
      font-size: 1.05em;
    }
    .novel-list .tag-badge {
      font-size: 0.78em;
      padding: 1px 10px;
    }
    /* æ›¸åº«å°èªªåˆ—è¡¨ç°¡ä»‹æœ€å¤šé¡¯ç¤º3è¡Œï¼Œè¶…å‡ºä»¥çœç•¥è™Ÿçµå°¾ */
    .novel-list .novel-meta.desc {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
    }
    /* æ‰¹æ¬¡åˆ†é¡é¸å–æ™‚èƒŒæ™¯è®Šæš— */
    .novel-item.selected {
      background: #e3e8ee !important;
    }
    #batchClassifySelect {
      width: 60%;
      height: 30px;
      font-size: 0.7em;   
    }
    #batchClassifyApplyBtn, #batchClassifyCancelBtn {
      width: 20%;
      height: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="page-reader" class="page">
      <h2>å°èªªé–±è®€å™¨</h2>
      <form id="novelForm">
        <label for="name">å°èªªåç¨±</label>
        <input type="text" id="name" required>
        <label for="author">ä½œè€…</label>
        <input type="text" id="author" required>
        <label for="category">åˆ†é¡</label>
        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
          <select id="category" required style="flex:1"></select>
        </div>
        <label for="url">ç¶²å€</label>
        <input type="url" id="url" placeholder="https://...">
        <label for="desc">ç°¡ä»‹</label>
        <textarea id="desc" rows="2"></textarea>
        <label for="date">æ—¥æœŸ</label>
        <input type="date" id="date">
        <label for="tags">æ¨™ç±¤ </label>
        <input type="text" id="tags" placeholder="æ¨™ç±¤ä»¥é€—è™Ÿåˆ†é¡">
        <label for="content">å…§æ–‡</label>
        <textarea id="content" rows="6" required></textarea>
        <button type="submit">æ–°å¢å°èªª</button>
      </form>
    </div>
    <div id="page-library" class="page" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;" id="libraryTopBar">
        <h2 id="libraryTitle" style="margin:0;">æ›¸åº«</h2>
        <div style="display:flex;gap:8px;">
          <button type="button" id="libByCategoryBtn" class="lib-mode-btn active">ä¾åˆ†é¡</button>
          <button type="button" id="libAllBtn" class="lib-mode-btn">å…¨éƒ¨</button>
        </div>
      </div>
      <div id="libCategoryView">
        <div class="novel-list" id="categoryListView"></div>
      </div>
      <div id="libAllView" style="display:none;">
        <div class="novel-list" id="allListView"></div>
      </div>
      <div id="libNovelsByCatView" style="display:none;">
        <div class="library-header" style="display:flex;align-items:center;justify-content:space-between;">
          <h2 id="catTitle"></h2>
          <span id="batchClassifyBtn" style="color:#4f8cff;cursor:pointer;font-size:0.9em;">æ‰¹æ¬¡åˆ†é¡</span>
        </div>
        <div id="batchClassifyBar" style="display:none;align-items:center;gap:8px;">
          <select id="batchClassifySelect"></select>
          <button id="batchClassifyApplyBtn" style="padding:4px 4px; font-size:0.7em;background:#515151;color:#fff;">å¥—ç”¨</button>
          <button id="batchClassifyCancelBtn" style="padding:4px 4px; font-size:0.7em;background:#515151;color:#fff;">å–æ¶ˆ</button>
        </div>
        <div class="novel-list" id="novelsByCatList"></div>
      </div>
    </div>
    <div id="page-reader-novel" class="page" style="display:none;position:fixed;z-index:100;left:0;top:0;width:100vw;height:100vh;background:var(--reader-bg,#fff);color:var(--reader-color,#222);overflow:auto;">
      <button id="readerEditBtn" style="position:absolute;top:18px;right:24px;z-index:102;background:none;border:none;color:#4f8cff;font-size:1em;cursor:pointer;">ç·¨è¼¯</button>
      <div id="readerContent" style="max-width:700px;margin:0 auto;padding:32px 16px 80px 16px;"></div>
      <div id="readerTools" style="position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,0.98);border-top:1px solid #ddd;padding:12px 0;display:flex;gap:16px;justify-content:center;align-items:center;transition:transform 0.3s;z-index:101;">
        <label>å­—é«”
          <select id="readerFontSize">
            <option value="16">æ¥µå°</option>
            <option value="18">å°</option>
            <option value="20">ä¸­</option>
            <option value="22">å¤§</option>
            <option value="24">ç‰¹å¤§</option>
            <option value="28">è¶…å¤§</option>
          </select>
        </label>
        <label>è¡Œè·
          <select id="readerLineHeight">
            <option value="1.2">æ¥µç·Š</option>
            <option value="1.4">ç·Š</option>
            <option value="1.6">ä¸€èˆ¬</option>
            <option value="1.8">å¯¬</option>
            <option value="2.0">ç‰¹å¯¬</option>
            <option value="2.4">è¶…å¯¬</option>
          </select>
        </label>
        <label>èƒŒæ™¯
          <select id="readerBgColor">
            <option value="#fff">ç™½</option>
            <option value="#f5f5dc">ç±³</option>
            <option value="#222">é»‘</option>
            <option value="#e3f2fd">è—</option>
          </select>
        </label>
        <button id="closeReaderBtn" style="margin-left:16px;">é—œé–‰</button>
      </div>
    </div>
    <div id="page-settings" class="page" style="display:none">
      <h2>è¨­å®š</h2>
      <div style="margin-bottom: 24px;">
        <label>ä¸»é¡Œï¼š
          <select id="themeSelect">
            <option value="light">äº®è‰²</option>
            <option value="dark">æš—è‰²</option>
          </select>
        </label>
      </div>
      <div style="margin-bottom: 24px;">
        <label>å­—é«”å¤§å°ï¼š
          <input type="range" id="fontSizeRange" min="14" max="28" value="18">
          <span id="fontSizeValue">18</span> px
        </label>
      </div>
      <div style="margin-bottom: 24px;">
        <label>è¡Œè·ï¼š
          <input type="range" id="lineHeightRange" min="1.2" max="2.2" step="0.1" value="1.6">
          <span id="lineHeightValue">1.6</span>
        </label>
      </div>
      <div style="margin-bottom: 24px;">
        <button type="button" id="editCategoryBtn" style="padding:6px 18px;">ç®¡ç†åˆ†é¡</button>
      </div>
      <div style="margin-bottom: 24px;">
        <label style="cursor:pointer;">
          <input type="file" id="importJsonInput" accept="application/json" style="display:none;" multiple>
          <button type="button" id="importJsonBtn" style="margin-bottom:0;">åŒ¯å…¥ JSON</button>
        </label>
      </div>
    </div>
    <nav class="bottom-nav">
      <button type="button" data-page="reader">é–±è®€å™¨</button>
      <button type="button" data-page="library">æ›¸åº«</button>
      <button type="button" data-page="settings">è¨­å®š</button>
    </nav>
    <!-- åˆ†é¡ç®¡ç†å°è©±æ¡† -->
    <dialog id="categoryDialog">
      <form method="dialog" id="categoryForm" style="min-width:260px;">
        <h3>ç®¡ç†åˆ†é¡</h3>
        <ul id="categoryList" style="list-style:none;padding:0;margin-bottom:12px;"></ul>
        <div style="display:flex;gap:8px;">
          <input type="text" id="newCategoryInput" placeholder="æ–°å¢åˆ†é¡" style="flex:1;">
          <button type="button" id="addCategoryBtn">æ–°å¢</button>
        </div>
        <div style="text-align:right;margin-top:12px;">
          <button type="submit">å®Œæˆ</button>
        </div>
      </form>
    </dialog>
  </div>
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAX0SfHvlelWWdg7Q-8WHzmWNdKE2vtI3w",
      authDomain: "to-buy-list-2323b.firebaseapp.com",
      projectId: "to-buy-list-2323b",
      storageBucket: "to-buy-list-2323b.firebasestorage.app",
      messagingSenderId: "363437967200",
      appId: "1:363437967200:web:798c997017e75d2a278005"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const novelsCol = collection(db, "novels");

    // æ–°å¢å°èªª
    const novelForm = document.getElementById('novelForm');
    const novelSubmitBtn = document.querySelector('#novelForm button[type="submit"]');
    // ç·¨è¼¯æ¨¡å¼å³æ™‚åŒæ­¥
    let editDebounceTimer = null;
    function autoSyncEdit() {
      if (!novelForm.dataset.editId) return;
      clearTimeout(editDebounceTimer);
      editDebounceTimer = setTimeout(async () => {
        const id = novelForm.dataset.editId;
        const name = document.getElementById('name').value.trim();
        const author = document.getElementById('author').value.trim();
        const category = document.getElementById('category').value;
        const url = document.getElementById('url').value.trim();
        const desc = document.getElementById('desc').value.trim();
        const date = document.getElementById('date').value;
        const tags = document.getElementById('tags').value.split(',').map(t=>t.trim()).filter(Boolean);
        const content = document.getElementById('content').value.trim();
        await updateDoc(doc(novelsCol, id), { name, author, category, url, desc, date, tags, content });
      }, 300);
    }
    // ç¶å®šæ‰€æœ‰æ¬„ä½
    ['name','author','category','url','desc','date','tags','content'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', autoSyncEdit);
      el.addEventListener('change', autoSyncEdit);
    });
    // é€å‡ºæ™‚åªé‡è¨­ç‹€æ…‹
    novelForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const author = document.getElementById('author').value.trim();
      const category = document.getElementById('category').value;
      const url = document.getElementById('url').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const date = document.getElementById('date').value;
      const tags = document.getElementById('tags').value.split(',').map(t=>t.trim()).filter(Boolean);
      const content = document.getElementById('content').value.trim();
      if (!name || !author || !category || !content) return;
      const editId = novelForm.dataset.editId;
      if (editId) {
        // ç·¨è¼¯æ¨¡å¼
        await updateDoc(doc(novelsCol, editId), { name, author, category, url, desc, date, tags, content });
        delete novelForm.dataset.editId;
      } else {
        // æ–°å¢
        await addDoc(novelsCol, { name, author, category, url, desc, date, tags, content, createdAt: Date.now() });
      }
      novelForm.reset();
      novelSubmitBtn.textContent = 'æ–°å¢å°èªª';
    });

    // åªç”¨æ–¼æ›¸åº«é¡¯ç¤º
    const q = query(novelsCol, orderBy('createdAt', 'desc'));
    let novelsCache = [];
    onSnapshot(q, (snapshot) => {
      novelsCache = [];
      snapshot.forEach(doc => {
        const { name, author, category, url, desc, date, tags, content } = doc.data();
        novelsCache.push({ id: doc.id, name, author, category, url, desc, date, tags, content });
      });
      renderLibrary(novelsCache);
      renderAllTagsList();
      renderCategoryOptions();
    });

    // åˆ†é åˆ‡æ›
    const pages = ['reader', 'library', 'settings'];
    const navBtns = document.querySelectorAll('.bottom-nav button');
    function showPage(page) {
      pages.forEach(p => {
        document.getElementById('page-' + p).style.display = (p === page) ? '' : 'none';
      });
      navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.page === page));
      // æ¯æ¬¡åˆ‡åˆ°æ›¸åº«éƒ½é¡¯ç¤ºåˆ†é¡é¦–é 
      if (page === 'library') {
        libCategoryView.style.display = '';
        libAllView.style.display = 'none';
        libNovelsByCatView.style.display = 'none';
        document.getElementById('libraryTitle').style.display = '';
        document.getElementById('libraryTopBar').style.display = '';
      }
    }
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => showPage(btn.dataset.page));
    });
    // é è¨­é¡¯ç¤ºé–±è®€å™¨
    showPage('reader');

    // ====== è¨­å®šåŠŸèƒ½ ======
    // ä¸»é¡Œåˆ‡æ›
    const themeSelect = document.getElementById('themeSelect');
    themeSelect.addEventListener('change', e => {
      document.body.setAttribute('data-theme', e.target.value);
      localStorage.setItem('novel-theme', e.target.value);
    });
    // å­—é«”å¤§å°
    const fontSizeRange = document.getElementById('fontSizeRange');
    const fontSizeValue = document.getElementById('fontSizeValue');
    fontSizeRange.addEventListener('input', e => {
      document.documentElement.style.setProperty('--novel-font-size', e.target.value + 'px');
      fontSizeValue.textContent = e.target.value;
      localStorage.setItem('novel-font-size', e.target.value);
    });
    // è¡Œè·
    const lineHeightRange = document.getElementById('lineHeightRange');
    const lineHeightValue = document.getElementById('lineHeightValue');
    lineHeightRange.addEventListener('input', e => {
      document.documentElement.style.setProperty('--novel-line-height', e.target.value);
      lineHeightValue.textContent = e.target.value;
      localStorage.setItem('novel-line-height', e.target.value);
    });
    // è¼‰å…¥æœ¬åœ°è¨­å®š
    window.addEventListener('DOMContentLoaded', () => {
      const theme = localStorage.getItem('novel-theme') || 'light';
      document.body.setAttribute('data-theme', theme);
      themeSelect.value = theme;
      const fontSize = localStorage.getItem('novel-font-size') || '18';
      document.documentElement.style.setProperty('--novel-font-size', fontSize + 'px');
      fontSizeRange.value = fontSize;
      fontSizeValue.textContent = fontSize;
      const lineHeight = localStorage.getItem('novel-line-height') || '1.6';
      document.documentElement.style.setProperty('--novel-line-height', lineHeight);
      lineHeightRange.value = lineHeight;
      lineHeightValue.textContent = lineHeight;
      // é è¨­åˆ†é¡
      const categorySelect = document.getElementById('category');
      if (categorySelect && categorySelect.options.length > 0) {
        categorySelect.value = 'æœªåˆ†é¡';
      }
    });

    // ====== åˆ†é¡ç®¡ç† ======
    const defaultCategories = ["æœªåˆ†é¡"];
    function getAllCategories() {
      // 1. localStorage è£¡çš„åˆ†é¡
      let cats = JSON.parse(localStorage.getItem('novel-categories') || 'null') || defaultCategories;
      // 2. novelsCache è£¡æ‰€æœ‰å‡ºç¾éçš„åˆ†é¡
      let novelCats = novelsCache.map(n => n.category).filter(Boolean);
      // 3. åˆä½µå»é‡
      let allCats = Array.from(new Set([...cats, ...novelCats]));
      return allCats;
    }
    function renderCategoryOptions() {
      const cats = getAllCategories();
      const prev = categorySelect.value;
      categorySelect.innerHTML = '';
      cats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
      // è‹¥ç›®å‰æœ‰é¸æ“‡åˆ†é¡ï¼Œä¿ç•™åŸé¸æ“‡
      if (cats.includes(prev)) {
        categorySelect.value = prev;
      } else if (cats.includes('æœªåˆ†é¡')) {
        categorySelect.value = 'æœªåˆ†é¡';
      } else if (cats.length > 0) {
        categorySelect.value = cats[0];
      }
    }
    // åˆå§‹åŒ–åˆ†é¡ä¸‹æ‹‰
    const categorySelect = document.getElementById('category');
    renderCategoryOptions();

    // åˆ†é¡ç®¡ç†å°è©±æ¡†
    const categoryDialog = document.getElementById('categoryDialog');
    const categoryList = document.getElementById('categoryList');
    const newCategoryInput = document.getElementById('newCategoryInput');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    document.getElementById('editCategoryBtn').onclick = () => {
      renderCategoryList();
      categoryDialog.showModal();
    };
    function renderCategoryList() {
      const cats = getAllCategories();
      categoryList.innerHTML = '';
      cats.forEach((cat, idx) => {
        const isDefault = cat === 'æœªåˆ†é¡';
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '6px';
        li.innerHTML = `
          <input type="text" value="${cat}" data-idx="${idx}" style="flex:1;" ${isDefault ? 'disabled' : ''}>
          ${isDefault ? '' : `<button type="button" data-idx="${idx}" class="delCatBtn">åˆªé™¤</button>`}
        `;
        categoryList.appendChild(li);
      });
    }
    // æ–°å¢åˆ†é¡
    addCategoryBtn.onclick = () => {
      const val = newCategoryInput.value.trim();
      if (!val) return;
      let cats = getAllCategories();
      if (!cats.includes(val)) {
        cats.push(val);
        localStorage.setItem('novel-categories', JSON.stringify(cats));
        renderCategoryList();
        renderCategoryOptions();
        newCategoryInput.value = '';
      }
    };
    // åˆªé™¤åˆ†é¡
    categoryList.addEventListener('click', e => {
      if (e.target.classList.contains('delCatBtn')) {
        const idx = +e.target.dataset.idx;
        let cats = getAllCategories();
        cats.splice(idx, 1);
        localStorage.setItem('novel-categories', JSON.stringify(cats));
        renderCategoryList();
        renderCategoryOptions();
      }
    });
    // ä¿®æ”¹åˆ†é¡
    categoryList.addEventListener('input', e => {
      if (e.target.tagName === 'INPUT') {
        const idx = +e.target.dataset.idx;
        let cats = getAllCategories();
        cats[idx] = e.target.value;
        localStorage.setItem('novel-categories', JSON.stringify(cats));
        renderCategoryOptions();
      }
    });
    // å®Œæˆé—œé–‰
    document.getElementById('categoryForm').onsubmit = e => {
      e.preventDefault();
      categoryDialog.close();
    };
    // è‹¥ localStorage æ²’æœ‰åˆ†é¡ï¼Œåˆå§‹åŒ–ä¸€æ¬¡
    if (!localStorage.getItem('novel-categories')) {
      localStorage.setItem('novel-categories', JSON.stringify(defaultCategories));
    }

    // ====== é–±è®€é åŠŸèƒ½ ======
    const pageReaderNovel = document.getElementById('page-reader-novel');
    const readerContent = document.getElementById('readerContent');
    const readerTools = document.getElementById('readerTools');
    const readerFontSize = document.getElementById('readerFontSize');
    const readerLineHeight = document.getElementById('readerLineHeight');
    const readerBgColor = document.getElementById('readerBgColor');
    const closeReaderBtn = document.getElementById('closeReaderBtn');
    let readerColorMap = { '#fff': '#222', '#f5f5dc': '#222', '#222': '#eee', '#e3f2fd': '#222' };
    let readerEditMode = false;
    let currentReaderNovelId = null;
    const readerEditBtn = document.getElementById('readerEditBtn');
    readerEditBtn.onclick = async () => {
      if (!readerEditMode) {
        // é€²å…¥ç·¨è¼¯æ¨¡å¼
        readerEditMode = true;
        readerEditBtn.textContent = 'å®Œæˆ';
        showReaderEditForm();
      } else {
        // å®Œæˆç·¨è¼¯ï¼Œå„²å­˜
        await saveReaderEditForm();
        readerEditMode = false;
        readerEditBtn.textContent = 'ç·¨è¼¯';
        // é‡æ–°é¡¯ç¤ºé–±è®€é 
        const novel = novelsCache.find(n => n.id === currentReaderNovelId);
        if (novel) showReaderPage(novel);
      }
    };
    function showReaderPage(novel) {
      currentReaderNovelId = novel.id;
      readerEditMode = false;
      readerEditBtn.textContent = 'ç·¨è¼¯';
      readerContent.innerHTML = `
        <div style="font-size:1.2em;font-weight:bold;margin-bottom:8px;display:flex;align-items:center;gap:12px;">
          <span>${novel.name}</span>
        </div>
        <div style="color:#888;font-size:0.8em;margin-bottom:8px;">${(novel.tags||[]).map(tag => `#${tag}`).join(' ')}</div>
        <div style="color:#888;font-size:0.8em;margin-bottom:8px;">ä½œè€…ï¼š${novel.author}ã€€åˆ†é¡ï¼š${novel.category}</div>
        <div style="color:#888;font-size:0.8em;margin-bottom:8px;">${novel.date ? 'æ—¥æœŸï¼š'+novel.date+'ã€€' : ''}</div>
        <div style="color:#888;font-size:0.8em;margin-bottom:8px;">${novel.url ? `<a href="${novel.url}" target="_blank">é€£çµ</a>` : ''}</div>
        <div style="color:#888;font-size:0.8em;margin-bottom:16px;">${(novel.desc||'').replace(/\r?\n/g, '<br>')}</div>
        <div class="novel-content" id="readerNovelContent">${(novel.content||'').replace(/\r?\n/g, '<br>')}</div>
      `;
      // å¥—ç”¨é è¨­
      readerFontSize.value = localStorage.getItem('reader-font-size') || 18;
      readerLineHeight.value = localStorage.getItem('reader-line-height') || 1.6;
      readerBgColor.value = localStorage.getItem('reader-bg') || '#fff';
      applyReaderStyle();
      pageReaderNovel.style.display = '';
      document.body.style.overflow = 'hidden';
      readerTools.classList.remove('hide');
    }
    function applyReaderStyle() {
      const fs = readerFontSize.value;
      const lh = readerLineHeight.value;
      const bg = readerBgColor.value;
      // åªèª¿æ•´å…§æ–‡
      const contentEl = document.getElementById('readerNovelContent');
      if (contentEl) {
        contentEl.style.fontSize = fs + 'px';
        contentEl.style.lineHeight = lh;
      }
      pageReaderNovel.style.setProperty('--reader-bg', bg);
      pageReaderNovel.style.setProperty('--reader-color', readerColorMap[bg] || '#222');
      localStorage.setItem('reader-font-size', fs);
      localStorage.setItem('reader-line-height', lh);
      localStorage.setItem('reader-bg', bg);
    }
    readerFontSize.addEventListener('change', applyReaderStyle);
    readerLineHeight.addEventListener('change', applyReaderStyle);
    readerBgColor.addEventListener('change', applyReaderStyle);
    // é—œé–‰é–±è®€é 
    closeReaderBtn.onclick = () => {
      pageReaderNovel.style.display = 'none';
      document.body.style.overflow = '';
    };
    // é»æ“Šè¢å¹•éš±è—/é¡¯ç¤ºå·¥å…·åˆ—
    let lastTap = 0;
    pageReaderNovel.addEventListener('click', e => {
      // é¿å…é»æ“Šå·¥å…·åˆ—æœ¬èº«
      if (e.target.closest('#readerTools')) return;
      if (readerTools.classList.contains('hide')) {
        readerTools.classList.remove('hide');
      } else {
        readerTools.classList.add('hide');
      }
    });
    // é€²å…¥é–±è®€é æ™‚è‡ªå‹•é¡¯ç¤ºå·¥å…·åˆ—
    // ... existing code ...

    // ====== æ›¸åº«é¡¯ç¤ºæ¨¡å¼ ======
    const libByCategoryBtn = document.getElementById('libByCategoryBtn');
    const libAllBtn = document.getElementById('libAllBtn');
    const libCategoryView = document.getElementById('libCategoryView');
    const libAllView = document.getElementById('libAllView');
    const libNovelsByCatView = document.getElementById('libNovelsByCatView');
    const categoryListView = document.getElementById('categoryListView');
    const allListView = document.getElementById('allListView');
    const novelsByCatList = document.getElementById('novelsByCatList');
    const catTitle = document.getElementById('catTitle');
    let currentLibMode = 'category';
    function switchLibMode(mode) {
      currentLibMode = mode;
      libByCategoryBtn.classList.toggle('active', mode==='category');
      libAllBtn.classList.toggle('active', mode==='all');
      libCategoryView.style.display = mode==='category' ? '' : 'none';
      libAllView.style.display = mode==='all' ? '' : 'none';
      libNovelsByCatView.style.display = 'none';
      document.getElementById('libraryTitle').style.display = '';
      document.getElementById('libraryTopBar').style.display = '';
    }
    libByCategoryBtn.onclick = () => switchLibMode('category');
    libAllBtn.onclick = () => switchLibMode('all');
    // æ›¸åº«è³‡æ–™æ¸²æŸ“
    function renderTagBadges(tags, small) {
      if (!tags || !tags.length) return '';
      return `<span class="tag-list">` + tags.map(tag => {
        return `<span class="tag-badge${small ? ' small' : ''}">${tag}</span>`;
      }).join('') + `</span>`;
    }
    function renderLibrary(novels) {
      // ä¾åˆ†é¡
      const cats = getAllCategories();
      categoryListView.innerHTML = '';
      cats.forEach(cat => {
        const count = novels.filter(n=>n.category===cat).length;
        categoryListView.innerHTML += `<div class="novel-item cat-item" data-cat="${cat}" style="cursor:pointer;">
          <div class="novel-title">${cat}</div>
          <div class="novel-meta">${count} æœ¬å°èªª</div>
        </div>`;
      });
      // å…¨éƒ¨
      const sorted = [...novels].sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
      allListView.innerHTML = '';
      sorted.forEach(novel => {
        allListView.innerHTML += `
          <div class="novel-item" data-id="${novel.id}" style="cursor:pointer;">
            <div class="novel-title">${novel.name}${renderTagBadges(novel.tags, true)}</div>
            <div class="novel-meta">ä½œè€…ï¼š${novel.author}ã€€åˆ†é¡ï¼š${novel.category}</div>
            <div class="novel-meta">${novel.date ? 'æ—¥æœŸï¼š'+novel.date+'ã€€' : ''}</div>
            <div class="novel-meta">${novel.url ? `<a href="${novel.url}" target="_blank">é€£çµ</a>` : ''}</div>
            <div class="novel-meta desc">${(novel.desc||'').replace(/\r?\n/g, '<br>')}</div>
          </div>
        `;
      });
    }
    // é»åˆ†é¡é¡¯ç¤ºè©²åˆ†é¡å°èªª
    categoryListView.addEventListener('click', e => {
      let item = e.target.closest('.cat-item');
      if (!item) return;
      let cat = item.dataset.cat;
      showNovelsByCategory(cat);
    });
    function showNovelsByCategory(cat) {
      catTitle.textContent = cat;
      libCategoryView.style.display = 'none';
      libNovelsByCatView.style.display = '';
      renderNovelsByCatList(cat);
      document.getElementById('libraryTitle').style.display = 'none';
      document.getElementById('libraryTopBar').style.display = 'none';
    }
    // 2. JS: æ‰¹æ¬¡åˆ†é¡æ¨¡å¼
    let batchClassifyMode = false;
    let batchSelectedIds = [];
    const batchClassifyBtn = document.getElementById('batchClassifyBtn');
    const batchClassifyBar = document.getElementById('batchClassifyBar');
    const batchClassifySelect = document.getElementById('batchClassifySelect');
    const batchClassifyApplyBtn = document.getElementById('batchClassifyApplyBtn');
    const batchClassifyCancelBtn = document.getElementById('batchClassifyCancelBtn');
    batchClassifyBtn.onclick = () => {
      batchClassifyMode = true;
      batchClassifyBar.style.display = 'flex';
      renderNovelsByCatList(catTitle.textContent);
      // å¡«å……åˆ†é¡ä¸‹æ‹‰
      const cats = getAllCategories();
      batchClassifySelect.innerHTML = cats.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    };
    batchClassifyCancelBtn.onclick = () => {
      batchClassifyMode = false;
      batchSelectedIds = [];
      batchClassifyBar.style.display = 'none';
      renderNovelsByCatList(catTitle.textContent);
    };
    batchClassifyApplyBtn.onclick = async () => {
      const newCat = batchClassifySelect.value;
      for (const id of batchSelectedIds) {
        await updateDoc(doc(novelsCol, id), { category: newCat });
        const idx = novelsCache.findIndex(n => n.id === id);
        if (idx !== -1) novelsCache[idx].category = newCat;
      }
      batchClassifyMode = false;
      batchSelectedIds = [];
      batchClassifyBar.style.display = 'none';
      renderLibrary(novelsCache);
      renderNovelsByCatList(newCat);
      catTitle.textContent = newCat;
    };
    // 3. renderNovelsByCatList å…§ï¼Œæ‰¹æ¬¡æ¨¡å¼ä¸‹ä¸é¡¯ç¤ºå‹¾é¸æ¡†ï¼Œé»æ“Š novel-item åˆ‡æ›é¸å–
    function renderNovelsByCatList(cat) {
      const novels = novelsCache.filter(n=>n.category===cat);
      novelsByCatList.innerHTML = '';
      novels.forEach((novel, idx) => {
        const selected = batchClassifyMode && batchSelectedIds.includes(novel.id);
        novelsByCatList.innerHTML += `
          <div class="novel-item${selected ? ' selected' : ''}" data-id="${novel.id}" style="border-bottom:${idx===novels.length-1?'none':'3px solid #e3e8ee'};">
            <div class="novel-row">
              <span class="novel-title">${novel.name}</span>
              <span class="novel-meta-row">
                <span>${novel.date || ''}</span>
              </span>
            </div>
            <div style="display:flex;align-items:center;margin:10px 0 0 24px;gap:20px;">
              <span style="color:#888; font-size:0.9em;">${novel.author || ''}</span>
              <div class="tag-list">${(novel.tags||[]).map(tag => `<span class=\"tag-badge\">${tag}</span>`).join('')}</div>
            </div>
            <div class="novel-desc">${(novel.desc||'').replace(/\r?\n/g, '<br>')}</div>
            <span class="novel-actions" style="display:none;">
              <button class="novel-action-btn delete-btn" title="åˆªé™¤" data-id="${novel.id}">ğŸ—‘ï¸</button>
            </span>
          </div>
        `;
      });
      // ç¶å®šé¸å–äº‹ä»¶
      if (batchClassifyMode) {
        novelsByCatList.querySelectorAll('.novel-item').forEach(item => {
          item.onclick = (e) => {
            const id = item.dataset.id;
            if (batchSelectedIds.includes(id)) {
              batchSelectedIds = batchSelectedIds.filter(x => x !== id);
              item.classList.remove('selected');
            } else {
              batchSelectedIds.push(id);
              item.classList.add('selected');
            }
          };
        });
      }
    }
    // ç·¨è¼¯/åˆªé™¤å°èªªäº‹ä»¶ä»£ç†
    novelsByCatList.addEventListener('click', async (e) => {
      // æ‰¹æ¬¡åˆ†é¡æ¨¡å¼ä¸‹ï¼Œé»æ“Š novel-item ä¸é€²å…¥é–±è®€é 
      if (batchClassifyMode) return;
      // åˆªé™¤
      if (e.target.classList.contains('delete-btn')) {
        const id = e.target.dataset.id;
        const novel = novelsCache.find(n => n.id === id);
        if (!novel) return;
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${novel.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) return;
        await deleteDoc(doc(novelsCol, id));
        return;
      }
      // åªæœ‰é»æ“Šå°èªªæ¨™é¡Œæ‰é–‹å•Ÿé–±è®€å™¨
      if (e.target.classList.contains('novel-title')) {
        const item = e.target.closest('.novel-item');
        if (!item) return;
        const id = item.dataset.id;
        const novel = novelsCache.find(n => n.id === id);
        if (!novel) return;
        showReaderPage(novel);
      }
    });

    // ====== æ¨™ç±¤è¨˜æ†¶èˆ‡é¸æ“‡ ======
    function getAllTagsFromNovels() {
      const tagsSet = new Set();
      novelsCache.forEach(novel => {
        if (Array.isArray(novel.tags)) {
          novel.tags.forEach(tag => tagsSet.add(tag));
        }
      });
      return Array.from(tagsSet).filter(Boolean);
    }
    function renderAllTagsList() {
      const allTags = getAllTagsFromNovels();
      const allTagsList = document.getElementById('allTagsList');
      if (!allTagsList) return;
      allTagsList.innerHTML = '';
      allTags.forEach(tag => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = tag;
        btn.className = 'tag-badge';
        btn.style.cursor = 'pointer';
        btn.onclick = () => {
          const tagsInput = document.getElementById('tags');
          let tagsArr = tagsInput.value.split(',').map(t=>t.trim()).filter(Boolean);
          if (!tagsArr.includes(tag)) {
            tagsArr.push(tag);
            tagsInput.value = tagsArr.join(', ');
          }
        };
        allTagsList.appendChild(btn);
      });
    }

    // åœ¨ script å…§åŠ ä¸ŠåŒ¯å…¥ JSON è™•ç†
    const importJsonBtn = document.getElementById('importJsonBtn');
    const importJsonInput = document.getElementById('importJsonInput');
    importJsonBtn.onclick = () => importJsonInput.click();
    importJsonInput.setAttribute('multiple', 'multiple');
    importJsonInput.onchange = async (e) => {
      const files = Array.from(e.target.files);
      if (!files.length) return;
      for (const file of files) {
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          // è‹¥ç‚ºé™£åˆ—ï¼Œæ‰¹æ¬¡åŒ¯å…¥
          const novels = Array.isArray(data) ? data : [data];
          for (const novel of novels) {
            if (novel.name) document.getElementById('name').value = novel.name;
            if (novel.author) document.getElementById('author').value = novel.author;
            if (novel.url) document.getElementById('url').value = novel.url;
            if (novel.tags) document.getElementById('tags').value = Array.isArray(novel.tags) ? novel.tags.join(', ') : novel.tags;
            if (novel.desc) document.getElementById('desc').value = novel.desc;
            if (novel.content) document.getElementById('content').value = novel.content.replace(/\\n/g, '\n');
            // æ–°å¢åˆ†é¡ï¼ˆè‹¥æœ‰ï¼‰
            if (novel.category) {
              let cats = getAllCategories();
              if (!cats.includes(novel.category)) {
                let localCats = JSON.parse(localStorage.getItem('novel-categories') || 'null') || defaultCategories;
                localCats.push(novel.category);
                localStorage.setItem('novel-categories', JSON.stringify(localCats));
                renderCategoryOptions();
              }
              document.getElementById('category').value = novel.category;
            }
            // æ—¥æœŸæ ¼å¼è½‰æ›
            if (novel.date) {
              let d = novel.date.trim();
              // æ”¯æ´ YYYY.M.Dã€YYYY.MM.DDã€YYYY.M.DDã€YYYY.MM.D
              const match = d.match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})$/);
              if (match) {
                const y = match[1];
                const m = match[2].padStart(2, '0');
                const day = match[3].padStart(2, '0');
                d = `${y}-${m}-${day}`;
              }
              document.getElementById('date').value = d;
            }
            // è‡ªå‹•é€å‡ºè¡¨å–®
            document.getElementById('novelForm').dispatchEvent(new Event('submit'));
          }
        } catch (err) {
          alert('JSON æ ¼å¼éŒ¯èª¤æˆ–æª”æ¡ˆç„¡æ³•è®€å–: ' + file.name);
        }
      }
      showPage('reader');
    };

    function showReaderEditForm() {
      const novel = novelsCache.find(n => n.id === currentReaderNovelId);
      if (!novel) return;
      // å–å¾—æ‰€æœ‰åˆ†é¡
      const cats = getAllCategories();
      const catOptions = cats.map(cat => `<option value="${cat}"${cat===novel.category?' selected':''}>${cat}</option>`).join('');
      readerContent.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:12px;max-width:600px;margin:0 auto;">
          <label>å°èªªåç¨±<input type="text" id="editName" value="${novel.name||''}" style="width:100%;"></label>
          <label>ä½œè€…<input type="text" id="editAuthor" value="${novel.author||''}" style="width:100%;"></label>
          <label>åˆ†é¡<select id="editCategory" style="width:100%;">${catOptions}</select></label>
          <label>ç¶²å€<input type="url" id="editUrl" value="${novel.url||''}" style="width:100%;"></label>
          <label>æ¨™ç±¤<input type="text" id="editTags" value="${(novel.tags||[]).join(', ')}" style="width:100%;"></label>
          <label>æ—¥æœŸ<input type="date" id="editDate" value="${novel.date||''}" style="width:100%;"></label>
          <label>ç°¡ä»‹<textarea id="editDesc" rows="2" style="width:100%;">${novel.desc||''}</textarea></label>
          <label>å…§æ–‡<textarea id="editContent" rows="8" style="width:100%;">${novel.content||''}</textarea></label>
        </div>
      `;
    }
    async function saveReaderEditForm() {
      const id = currentReaderNovelId;
      if (!id) return;
      const name = document.getElementById('editName').value.trim();
      const author = document.getElementById('editAuthor').value.trim();
      const category = document.getElementById('editCategory').value.trim();
      const url = document.getElementById('editUrl').value.trim();
      const tags = document.getElementById('editTags').value.split(',').map(t=>t.trim()).filter(Boolean);
      const date = document.getElementById('editDate').value;
      const desc = document.getElementById('editDesc').value.trim();
      const content = document.getElementById('editContent').value.trim();
      await updateDoc(doc(novelsCol, id), { name, author, category, url, tags, date, desc, content });
      // ç«‹å³æ›´æ–° novelsCache
      const idx = novelsCache.findIndex(n => n.id === id);
      if (idx !== -1) {
        novelsCache[idx] = { ...novelsCache[idx], name, author, category, url, tags, date, desc, content };
      }
      // ç«‹å³é‡æ–°æ¸²æŸ“æ›¸åº«
      renderLibrary(novelsCache);
      // è‹¥ç›®å‰åœ¨åˆ†é¡é ï¼Œä¸”åˆ†é¡å·²è®Šï¼Œé‡æ–°æ¸²æŸ“åˆ†é¡åˆ—è¡¨
      if (document.getElementById('libNovelsByCatView').style.display !== 'none') {
        renderNovelsByCatList(category);
        document.getElementById('catTitle').textContent = category;
      }
    }
  </script>
</body>
</html> 